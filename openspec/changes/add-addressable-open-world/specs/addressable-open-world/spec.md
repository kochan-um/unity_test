## ADDED Requirements

### Requirement: ワールドチャンクグリッド管理
システムはワールドを固定サイズの正方形グリッドに分割し、各チャンクをユニークなチャンクID（`chunk_{x}_{z}` 形式）で管理しなければならない（SHALL）。
ワールド座標からチャンクIDへの変換、およびチャンクIDからワールド座標範囲への逆変換を O(1) で実行できなければならない（SHALL）。

#### Scenario: ワールド座標からチャンクIDを取得する
- **WHEN** プレイヤーがワールド座標 (150, 0, 250) に位置する
- **AND** チャンクサイズが 100m × 100m に設定されている
- **THEN** システムはチャンクID `chunk_1_2` を返す

#### Scenario: チャンクIDからワールド座標範囲を取得する
- **WHEN** チャンクID `chunk_1_2` の座標範囲を要求する
- **AND** チャンクサイズが 100m × 100m に設定されている
- **THEN** システムは中心座標 (150, 0, 250) と境界 (100-200, 0, 200-300) を返す

#### Scenario: 負の座標領域のチャンクID
- **WHEN** プレイヤーがワールド座標 (-50, 0, -150) に位置する
- **AND** チャンクサイズが 100m × 100m に設定されている
- **THEN** システムはチャンクID `chunk_-1_-2` を返す

---

### Requirement: プレイヤー位置ベースのチャンク自動ロード
システムはプレイヤーの現在位置を監視し、設定されたロード半径（loadRadius）内にあるすべてのチャンクを自動的に非同期ロードしなければならない（SHALL）。
ロード半径外に出たチャンクは自動的にアンロードしなければならない（SHALL）。

#### Scenario: プレイヤー移動によるチャンクロード
- **WHEN** プレイヤーがチャンク `chunk_1_2` の中心に移動する
- **AND** loadRadius が 2チャンク分に設定されている
- **THEN** `chunk_1_2` を中心とした5×5の範囲（距離2以内）のチャンクがロードキューに追加される

#### Scenario: プレイヤー移動によるチャンクアンロード
- **WHEN** プレイヤーが `chunk_1_2` から `chunk_3_2` に移動する
- **AND** loadRadius が 2チャンク分に設定されている
- **THEN** `chunk_3_2` 基準でloadRadius外となったチャンクがアンロードされる
- **AND** 新たにloadRadius内となったチャンクがロードキューに追加される

#### Scenario: ロード半径の動的変更
- **WHEN** ランタイムでloadRadiusが3から2に変更される
- **THEN** 新しい半径の外にあるチャンクがアンロード対象としてマークされる

---

### Requirement: Addressable非同期ロードキュー
システムはチャンクのロード要求を距離ベースの優先度キューで管理し、プレイヤーに近いチャンクから優先的にロードしなければならない（SHALL）。
同時並行ロード数は設定値（maxConcurrentLoads）で制限しなければならない（SHALL）。

#### Scenario: 距離ベースの優先ロード
- **WHEN** チャンク `chunk_1_2`（距離0）と `chunk_3_4`（距離2.8）が同時にロードキューに入る
- **THEN** `chunk_1_2` が先にロード開始される

#### Scenario: 並行ロード数の制限
- **WHEN** maxConcurrentLoads が 3 に設定されている
- **AND** 10個のチャンクがロードキューに存在する
- **THEN** 同時に実行されるAddressableロード操作は最大3件である

#### Scenario: 移動中の優先度再計算
- **WHEN** チャンクAがロードキューに入った後にプレイヤーが移動する
- **AND** チャンクAよりもプレイヤーに近いチャンクBが新たにキューに追加される
- **THEN** チャンクBの優先度がチャンクAより高く設定される

---

### Requirement: LOD（Level of Detail）切り替え
システムはプレイヤーからの距離に応じて各チャンクのLODレベル（High / Medium / Low）を自動的に切り替えなければならない（SHALL）。
LODの切り替えは非同期で行い、ゲームプレイのフレームレートに影響を与えてはならない（SHALL）。

#### Scenario: 近距離チャンクはHighLOD
- **WHEN** チャンクがプレイヤーからloadRadius以内にある
- **THEN** そのチャンクはHigh LODアセットで表示される

#### Scenario: 中距離チャンクはMediumLOD
- **WHEN** チャンクがプレイヤーからloadRadiusからlodMediumRadiusの範囲にある
- **THEN** そのチャンクはMedium LODアセット（簡略メッシュ）で表示される

#### Scenario: 遠距離チャンクはLowLOD
- **WHEN** チャンクがプレイヤーからlodMediumRadiusからlodLowRadiusの範囲にある
- **THEN** そのチャンクはLow LODアセット（インポスター or 最小メッシュ）で表示される

#### Scenario: LOD遷移のスムーズさ
- **WHEN** チャンクのLODレベルがHighからMediumに切り替わる
- **THEN** 新LODアセットのロード完了後に旧LODアセットと入れ替えが行われる
- **AND** 切り替え中にチャンクが非表示になることはない

---

### Requirement: メモリバジェット管理
システムはロード済みチャンクのメモリ使用量を監視し、設定されたメモリバジェット上限を超過した場合にLRU（Least Recently Used）方式で遠方チャンクをアンロードしなければならない（SHALL）。
メモリバジェットはScriptableObjectで設定可能でなければならない（SHALL）。

#### Scenario: メモリバジェット超過時のアンロード
- **WHEN** ロード済みチャンクの合計メモリが設定バジェット（例: 512MB）を超過する
- **THEN** プレイヤーから最も遠く、最も長くアクセスされていないチャンクから順にアンロードされる
- **AND** メモリ使用量がバジェット以下に戻るまでアンロードが継続する

#### Scenario: プレイヤー周囲チャンクのアンロード保護
- **WHEN** メモリバジェット超過によるパージが実行される
- **THEN** プレイヤーから最小保護半径（minProtectedRadius）内のチャンクはアンロードされない

#### Scenario: プラットフォーム別バジェット設定
- **WHEN** ビルドターゲットがモバイル（Android/iOS）である
- **THEN** モバイル用のメモリバジェット設定（例: 256MB）が適用される
- **AND** PC用（例: 1024MB）とは独立して設定可能である

---

### Requirement: チャンク境界オブジェクト管理
システムはチャンク境界をまたぐオブジェクト（建物、地形の継ぎ目等）を正しく管理し、チャンクロード・アンロード時に視覚的な不整合が生じないようにしなければならない（SHALL）。

#### Scenario: 境界オブジェクトの参照保持
- **WHEN** オブジェクトAがチャンク `chunk_1_2` と `chunk_2_2` の境界にまたがっている
- **AND** `chunk_1_2` がロードされ `chunk_2_2` がまだロードされていない
- **THEN** オブジェクトAは `chunk_1_2` のロード時に表示される

#### Scenario: 境界オーバーラップ領域
- **WHEN** チャンク境界オーバーラップが 10m に設定されている
- **THEN** 各チャンクは隣接チャンクとの境界から10m分のオブジェクトを重複して保持する
- **AND** 両チャンクがロードされた際に重複オブジェクトは1つだけ表示される

---

### Requirement: WorldStreamer設定（ScriptableObject）
システムはワールドストリーミングの全設定をScriptableObjectとして管理し、エディタ上で変更可能でなければならない（SHALL）。

#### Scenario: 設定項目の定義
- **WHEN** WorldStreamerSettingsアセットを作成する
- **THEN** 以下の項目が設定可能である:
  - chunkSize（チャンクサイズ、デフォルト: 100m）
  - loadRadius（ロード半径、デフォルト: 3チャンク）
  - unloadRadius（アンロード半径、デフォルト: loadRadius + 1）
  - maxConcurrentLoads（最大同時ロード数、デフォルト: 3）
  - lodMediumRadius（Medium LOD半径、デフォルト: 5チャンク）
  - lodLowRadius（Low LOD半径、デフォルト: 8チャンク）
  - memoryBudgetMB（メモリバジェット、デフォルト: 512MB）
  - minProtectedRadius（最小保護半径、デフォルト: 1チャンク）
  - enableDebugGizmos（デバッグ表示、デフォルト: false）

#### Scenario: ランタイムでの設定変更
- **WHEN** ランタイムでloadRadiusの値を変更する
- **THEN** WorldStreamerは次のUpdate時から新しい値に基づいてチャンクロード判定を行う

---

### Requirement: Addressableアセットグループ構成
システムはチャンクアセットをAddressableグループとして構成し、ラベルベースでロード・アンロードを管理しなければならない（SHALL）。
ローカルビルドとリモートCDN配信の両方のプロファイルに対応しなければならない（SHALL）。

#### Scenario: チャンクのAddressableラベル
- **WHEN** チャンク `chunk_1_2` のアセットをAddressableに登録する
- **THEN** ラベル `chunk_1_2` が付与される
- **AND** LODレベルに応じて `lod_high`、`lod_medium`、`lod_low` のラベルも併せて付与される

#### Scenario: ローカルビルドプロファイル
- **WHEN** Addressableプロファイルが「Local」に設定されている
- **THEN** チャンクアセットはビルドに含まれ、ローカルファイルシステムからロードされる

#### Scenario: リモートプロファイル
- **WHEN** Addressableプロファイルが「Remote」に設定されている
- **THEN** チャンクアセットはリモートURLからダウンロードされる
- **AND** ダウンロード済みアセットはローカルにキャッシュされる

---

### Requirement: エディタ拡張（チャンク分割ツール）
システムはUnityエディタ上でシーン内のオブジェクトを自動的にチャンクグリッドに分割するエディタウィンドウを提供しなければならない（SHALL）。

#### Scenario: 自動チャンク分割
- **WHEN** ChunkSplitterWindowでシーンを選択し「分割実行」を押す
- **THEN** シーン内の全GameObjectがグリッド座標に基づいてチャンクグループに分類される
- **AND** 各チャンクグループがAddressableアセットとして登録される

#### Scenario: 分割プレビュー
- **WHEN** ChunkSplitterWindowでチャンクサイズを設定する
- **THEN** Sceneビューにグリッド境界がギズモとして表示される
- **AND** 各チャンクに含まれるオブジェクト数が表示される

---

### Requirement: デバッグ可視化
システムはランタイムおよびエディタにおいて、チャンクの状態を視覚的にデバッグできる機能を提供しなければならない（SHALL）。

#### Scenario: ランタイムデバッグUI
- **WHEN** enableDebugGizmos が true に設定されている
- **THEN** 画面上にオーバーレイとして以下が表示される:
  - ロード済みチャンク数とメモリ使用量
  - ロードキューの残りチャンク数
  - 現在のプレイヤーチャンク座標

#### Scenario: Sceneビューチャンクギズモ
- **WHEN** WorldStreamerがシーンに配置されている
- **AND** enableDebugGizmos が true である
- **THEN** Sceneビューに各チャンクの境界が色分けされたワイヤーフレームで表示される
  - 緑: ロード済み（High LOD）
  - 黄: ロード済み（Medium/Low LOD）
  - 赤: アンロード済み
  - 青: ロード中

---

### Requirement: チャンクロード時のフェードイン演出
システムはチャンクのロード完了時にフェードインエフェクトを適用し、オブジェクトの突然の出現（ポップイン）を軽減しなければならない（SHALL）。

#### Scenario: フェードイン演出の実行
- **WHEN** チャンクのロードが完了する
- **THEN** チャンク内の全レンダラーが透明から不透明へ設定時間（デフォルト: 0.5秒）かけてフェードインする

#### Scenario: フェードイン無効化オプション
- **WHEN** フェードイン演出が無効に設定されている
- **THEN** チャンクはロード完了と同時に即座に表示される
