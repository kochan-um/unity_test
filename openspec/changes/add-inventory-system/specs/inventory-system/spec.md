## ADDED Requirements

### Requirement: アイテム定義システム
ゲーム内アイテムはScriptableObject (`ItemDefinition`) として定義されなければならない（SHALL）。
各アイテムは一意のID、表示名、説明文、アイコン、カテゴリ参照、最大スタック数、使用可能フラグ、破棄可能フラグを持たなければならない（SHALL）。

#### Scenario: アイテム定義の作成
- **WHEN** デザイナーがUnityエディタでItemDefinition ScriptableObjectを作成する
- **THEN** アイテムのID、表示名、説明文、アイコン、カテゴリ、最大スタック数、使用可能フラグ、破棄可能フラグを設定できる

#### Scenario: アイテムIDの一意性
- **WHEN** ItemDatabaseに同一IDのアイテムが登録されようとする
- **THEN** 警告ログが出力され、重複アイテムは登録されない

### Requirement: アイテムカテゴリシステム
アイテムカテゴリはScriptableObject (`ItemCategory`) として定義されなければならない（SHALL）。
カテゴリはエディタ上で自由に追加・編集でき、コード変更なしに新しいカテゴリを定義できなければならない（SHALL）。

#### Scenario: カスタムカテゴリの追加
- **WHEN** デザイナーがUnityエディタで新しいItemCategory ScriptableObjectを作成する
- **THEN** コードの再コンパイルなしに新しいカテゴリが利用可能になる

#### Scenario: カテゴリによるフィルタリング
- **WHEN** プレイヤーがインベントリUIでカテゴリタブを選択する
- **THEN** 選択したカテゴリに属するアイテムのみが表示される

### Requirement: アイテムデータベース
全アイテム定義を管理するレジストリ (`ItemDatabase`) がScriptableObjectとして存在しなければならない（SHALL）。
IDによるアイテム定義の検索をO(1)で提供しなければならない（SHALL）。

#### Scenario: IDによるアイテム検索
- **WHEN** システムがアイテムID文字列でItemDatabaseを検索する
- **THEN** 対応するItemDefinitionが返される。存在しない場合はnullが返される

### Requirement: インベントリスロット管理
インベントリは固定サイズのスロット配列で管理されなければならない（SHALL）。
各スロットはItemDefinitionへの参照と数量を保持する。

#### Scenario: アイテムの追加（空きスロットあり）
- **WHEN** インベントリにアイテムが追加され、既存スタックに空きがあるか空きスロットがある
- **THEN** 既存スタックに加算されるか、空きスロットに配置される

#### Scenario: アイテムの追加（容量オーバー）
- **WHEN** インベントリがすべてのスロットで満杯であり、既存スタックにも空きがない
- **THEN** アイテムは追加されず、追加失敗が通知される

#### Scenario: アイテムの削除
- **WHEN** 指定スロットからアイテムを削除する
- **THEN** 指定数量が減算され、数量が0になった場合はスロットが空になる

#### Scenario: スロット間のアイテム移動
- **WHEN** あるスロットから別のスロットにアイテムを移動する
- **THEN** 移動先が空の場合はそのまま配置され、同一アイテムの場合はスタック結合され、異なるアイテムの場合はスワップされる

### Requirement: スタックシステム
同一アイテムは `maxStackSize` まで1つのスロットにスタックできなければならない（SHALL）。
スタック数がmaxStackSizeを超える場合は次の空きスロットに分割しなければならない（SHALL）。

#### Scenario: スタック可能アイテムの追加
- **WHEN** maxStackSize=99のアイテムが50個入っているスロットに30個追加する
- **THEN** そのスロットの数量が80になる

#### Scenario: スタック上限を超える追加
- **WHEN** maxStackSize=99のアイテムが80個入っているスロットに30個追加する
- **THEN** 元のスロットは99個になり、残りの11個が次の空きスロットに配置される

#### Scenario: スタック不可アイテム
- **WHEN** maxStackSize=1のアイテムを追加する
- **THEN** 常に1つのスロットに1個のみ配置される

### Requirement: ソート機能
インベントリ内のアイテムをソートできなければならない（SHALL）。
ソート基準としてカテゴリ別、名前順、数量順を提供しなければならない（SHALL）。

#### Scenario: カテゴリ別ソート
- **WHEN** プレイヤーがカテゴリ別ソートを選択する
- **THEN** アイテムがカテゴリのソート順で並び替えられ、同一カテゴリ内は名前順になる

#### Scenario: 空スロットの整理
- **WHEN** ソートが実行される
- **THEN** アイテムが前詰めされ、空スロットは末尾にまとめられる

### Requirement: インベントリイベントシステム
インベントリの状態変化はイベント（C# event）で通知されなければならない（SHALL）。
OnItemAdded, OnItemRemoved, OnItemMoved, OnSlotUpdated イベントを提供しなければならない（SHALL）。

#### Scenario: アイテム追加時のイベント発火
- **WHEN** アイテムがインベントリに追加される
- **THEN** OnItemAddedイベントが発火し、追加されたアイテム情報とスロットインデックスが通知される

#### Scenario: アイテム移動時のイベント発火
- **WHEN** スロット間でアイテムが移動される
- **THEN** OnItemMovedイベントが発火し、移動元・移動先のスロットインデックスが通知される

### Requirement: ドラッグ&ドロップUI
インベントリUIはuGUIベースのドラッグ&ドロップでアイテムの移動をサポートしなければならない（SHALL）。
ドラッグ中はゴーストアイテム（半透明のアイコン）がカーソルに追従しなければならない（SHALL）。

#### Scenario: スロット間のドラッグ&ドロップ
- **WHEN** プレイヤーがスロットAのアイテムをドラッグしてスロットBにドロップする
- **THEN** アイテムがスロットAからスロットBに移動される（スワップまたはスタック結合）

#### Scenario: 無効な場所へのドロップ
- **WHEN** プレイヤーがアイテムをインベントリ外にドロップする
- **THEN** アイテムは元のスロットに戻る

#### Scenario: ドラッグ中の視覚フィードバック
- **WHEN** プレイヤーがアイテムのドラッグを開始する
- **THEN** 半透明のゴーストアイコンがカーソル位置に表示され、元のスロットは半透明になる

### Requirement: ツールチップUI
インベントリスロットにカーソルを合わせた際にアイテムの詳細情報を表示しなければならない（SHALL）。

#### Scenario: ツールチップの表示
- **WHEN** プレイヤーがアイテムのあるスロットにカーソルを合わせる
- **THEN** アイテム名、説明文、カテゴリ、スタック数が表示されるツールチップが表示される

#### Scenario: ツールチップの非表示
- **WHEN** プレイヤーがカーソルをスロットから離す
- **THEN** ツールチップが非表示になる

### Requirement: コンテキストメニュー
アイテムスロットの右クリック（または長押し）でコンテキストメニューを表示しなければならない（SHALL）。
使用可能なアイテムには「使用」、破棄可能なアイテムには「破棄」オプションを表示しなければならない（SHALL）。

#### Scenario: コンテキストメニューの表示
- **WHEN** プレイヤーがアイテムのあるスロットを右クリックする
- **THEN** コンテキストメニューが表示され、アイテムのフラグに応じた操作オプションが表示される

#### Scenario: アイテムの使用
- **WHEN** プレイヤーがコンテキストメニューから「使用」を選択する
- **THEN** アイテムに紐づいたIItemActionが実行され、消費アイテムの場合は数量が1減少する

#### Scenario: アイテムの破棄
- **WHEN** プレイヤーがコンテキストメニューから「破棄」を選択する
- **THEN** 確認ダイアログが表示され、確認後にアイテムがインベントリから削除される

### Requirement: アイテムアクションシステム
アイテム使用時の振る舞いは `IItemAction` インターフェースで定義されなければならない（SHALL）。
ItemDefinitionにアクション参照を設定でき、アイテムごとに異なる使用効果を実現しなければならない（SHALL）。

#### Scenario: 消費アイテムの使用
- **WHEN** 回復ポーションなどの消費アイテムが使用される
- **THEN** IItemAction.Executeが呼ばれ、アイテム固有の効果が発動し、数量が1減少する

#### Scenario: アクション未設定アイテムの使用
- **WHEN** IItemActionが設定されていないアイテムで「使用」を試みる
- **THEN** 操作は無視され、UIに「使用」オプションが表示されない

### Requirement: ワールドアイテム
ワールド上にアイテムオブジェクト (`WorldItem`) を配置でき、プレイヤーがピックアップできなければならない（SHALL）。
インベントリからアイテムをドロップしてワールドに配置できなければならない（SHALL）。

#### Scenario: アイテムのピックアップ
- **WHEN** プレイヤーがワールドアイテムのトリガー範囲に入りインタラクトキーを押す
- **THEN** アイテムがインベントリに追加され、ワールドオブジェクトが破棄される

#### Scenario: インベントリ満杯時のピックアップ
- **WHEN** インベントリが満杯の状態でアイテムをピックアップしようとする
- **THEN** ピックアップが失敗し、ワールドアイテムはそのまま残り、UIに通知メッセージが表示される

#### Scenario: アイテムのドロップ
- **WHEN** プレイヤーがインベントリからアイテムをワールドにドロップする
- **THEN** プレイヤーの前方にアイテムのワールドプレハブが生成され、インベントリから数量が減少する

### Requirement: Supabaseによる永続化
インベントリデータはSupabaseデータベースに保存・読み込みできなければならない（SHALL）。
永続化ロジックは `IInventoryRepository` インターフェースで抽象化されなければならない（SHALL）。

#### Scenario: インベントリの保存
- **WHEN** セーブがトリガーされる（自動セーブまたは手動セーブ）
- **THEN** 現在のインベントリ状態がSupabaseデータベースに送信・保存される

#### Scenario: インベントリの読み込み
- **WHEN** ゲーム起動時またはログイン後にインベントリをロードする
- **THEN** Supabaseからプレイヤーのインベントリデータが取得され、インベントリが復元される

#### Scenario: オフライン時のフォールバック
- **WHEN** Supabaseへの接続が失敗する
- **THEN** ローカルキャッシュからインベントリが読み込まれ、接続回復時にSupabaseと同期される

#### Scenario: データ整合性
- **WHEN** Supabaseに保存されたアイテムIDがItemDatabaseに存在しない
- **THEN** 該当アイテムはスキップされ、警告ログが出力される
