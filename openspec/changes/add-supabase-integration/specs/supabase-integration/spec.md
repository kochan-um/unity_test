## ADDED Requirements

### Requirement: Supabase接続の初期化と設定管理
システムはScriptableObjectベースの設定（`SupabaseSettings`）からSupabase URLとAnon Keyを読み込み、アプリケーション起動時にSupabaseクライアントを初期化しなければならない（SHALL）。
APIキーをソースコードにハードコードしてはならない（SHALL NOT）。

#### Scenario: 正常な接続初期化
- **WHEN** SupabaseSettingsに有効なURLとAnon Keyが設定されている
- **THEN** SupabaseManagerがSupabaseクライアントを正常に初期化し、接続可能な状態になる

#### Scenario: 設定が欠落している場合のエラー
- **WHEN** SupabaseSettingsのURLまたはAnon Keyが空である
- **THEN** 明確なエラーメッセージをログに出力し、Supabase関連機能を無効化する

#### Scenario: APIキーのセキュリティ
- **WHEN** プロジェクトがGitリポジトリにコミットされる
- **THEN** Anon Keyを含むSupabaseSettings実アセットは`.gitignore`により追跡対象外となる

---

### Requirement: メール/パスワードによるユーザー認証
システムはSupabase Authを通じて、メールアドレスとパスワードによるユーザーのサインアップ・ログイン・ログアウト機能を提供しなければならない（SHALL）。
認証セッションはアプリケーション再起動後も維持されなければならない（SHALL）。

#### Scenario: 新規ユーザーのサインアップ
- **WHEN** 有効なメールアドレスとパスワード（8文字以上）でサインアップを実行する
- **THEN** Supabase Authにユーザーが作成され、セッショントークンが返される

#### Scenario: 既存ユーザーのログイン
- **WHEN** 登録済みのメールアドレスと正しいパスワードでログインを実行する
- **THEN** 認証が成功し、アクセストークンとリフレッシュトークンが取得される

#### Scenario: 無効な認証情報によるログイン失敗
- **WHEN** 誤ったパスワードまたは未登録のメールアドレスでログインを実行する
- **THEN** 認証が失敗し、ユーザーに分かりやすいエラーメッセージが返される

#### Scenario: ログアウト
- **WHEN** 認証済みユーザーがログアウトを実行する
- **THEN** ローカルセッションが破棄され、Supabase側のセッションも無効化される

#### Scenario: セッションの自動復元
- **WHEN** 有効なリフレッシュトークンが保存された状態でアプリケーションを再起動する
- **THEN** 自動的にセッションが復元され、再ログインが不要となる

---

### Requirement: プレイヤーデータのCRUD操作
システムはSupabase Database（PostgREST API）を通じて、認証済みユーザーのプレイヤーデータに対するCreate・Read・Update・Delete操作を提供しなければならない（SHALL）。

#### Scenario: プレイヤープロフィールの作成
- **WHEN** 認証済みユーザーが初回ログイン後にプロフィールデータを送信する
- **THEN** `player_profiles`テーブルにユーザーIDと紐づいたレコードが作成される

#### Scenario: プレイヤーデータの取得
- **WHEN** 認証済みユーザーが自身のプロフィールデータを要求する
- **THEN** 当該ユーザーのレコードがJSON形式で返される

#### Scenario: プレイヤーデータの更新
- **WHEN** 認証済みユーザーがプロフィールデータ（表示名・統計情報等）を更新する
- **THEN** 該当レコードが更新され、更新後のデータが返される

#### Scenario: 未認証ユーザーのアクセス拒否
- **WHEN** 認証されていないクライアントがデータベース操作を試行する
- **THEN** 操作が拒否され、認証が必要である旨のエラーが返される

---

### Requirement: ファイルストレージ操作
システムはSupabase Storageを通じて、認証済みユーザーによるファイルのアップロード・ダウンロード・削除・一覧取得を提供しなければならない（SHALL）。
バケットのアクセス制御（public/private）に従い、認証状態に応じた適切なアクセス制限を行わなければならない（SHALL）。

#### Scenario: ファイルのアップロード
- **WHEN** 認証済みユーザーがバイナリデータとファイルパスを指定してアップロードを実行する
- **THEN** 指定バケットのパスにファイルが保存され、ファイルのメタデータ（パス・サイズ）が返される

#### Scenario: ファイルのダウンロード
- **WHEN** 認証済みユーザーがバケット名とファイルパスを指定してダウンロードを要求する
- **THEN** ファイルのバイナリデータが取得される

#### Scenario: 署名付きURLの生成
- **WHEN** 認証済みユーザーがprivateバケット内のファイルに対して署名付きURLを要求する
- **THEN** 指定した有効期限付きの一時アクセスURLが生成される

#### Scenario: ファイルの削除
- **WHEN** 認証済みユーザーが自身がアップロードしたファイルの削除を要求する
- **THEN** ストレージからファイルが削除され、以降のアクセスが不可となる

#### Scenario: ファイル一覧の取得
- **WHEN** 認証済みユーザーがバケット内の特定パス配下のファイル一覧を要求する
- **THEN** ファイル名・サイズ・更新日時を含むメタデータのリストが返される

#### Scenario: 未認証ユーザーのprivateバケットへのアクセス拒否
- **WHEN** 認証されていないクライアントがprivateバケットへの操作を試行する
- **THEN** 操作が拒否され、認証が必要である旨のエラーが返される

#### Scenario: publicバケットの読み取りアクセス
- **WHEN** publicバケットに対してファイルダウンロードまたはURL取得を要求する
- **THEN** 認証状態に関わらずファイルへのアクセスが許可される

#### Scenario: アップロードサイズ制限
- **WHEN** 設定された最大ファイルサイズ（デフォルト50MB）を超えるファイルのアップロードを試行する
- **THEN** アップロードが拒否され、サイズ超過のエラーメッセージが返される

---

### Requirement: WebGL環境での通信互換性
システムはWebGLビルド環境において、すべてのSupabase通信がUnityWebRequestベースのHTTPクライアントを経由して正常に動作しなければならない（SHALL）。

#### Scenario: WebGLビルドでのAPI呼び出し
- **WHEN** WebGLビルドされたアプリケーションからSupabase APIを呼び出す
- **THEN** UnityWebRequestを使用してHTTPS通信が行われ、正常なレスポンスが返される

#### Scenario: CORS制約への対応
- **WHEN** WebGLブラウザ環境からSupabaseエンドポイントにリクエストを送信する
- **THEN** Supabaseが返すCORSヘッダーにより、ブラウザがリクエストをブロックしない

---

### Requirement: エラーハンドリングとリトライ
システムはSupabaseとの通信失敗時に適切なエラーハンドリングを行い、一時的な障害に対してはリトライ機構を提供しなければならない（SHALL）。

#### Scenario: ネットワークタイムアウト
- **WHEN** Subase APIへのリクエストが指定タイムアウト（デフォルト30秒）以内に応答しない
- **THEN** タイムアウトエラーとしてコールバックに通知され、ゲーム進行がブロックされない

#### Scenario: 一時的なネットワーク障害のリトライ
- **WHEN** 通信エラー（5xx系レスポンスまたはネットワークエラー）が発生する
- **THEN** 指数バックオフ（最大3回）でリトライし、すべて失敗した場合にエラーを通知する

#### Scenario: 永続的なエラーの即座の通知
- **WHEN** クライアントエラー（4xx系レスポンス）が発生する
- **THEN** リトライせずに即座にエラー内容をコールバックに通知する
